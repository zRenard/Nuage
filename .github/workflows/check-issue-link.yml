name: Require GitHub Issue Link in PR

on:
  pull_request:
    types: [opened, edited, synchronize]

jobs:
  check-issue-link:
    runs-on: ubuntu-latest
    steps:
      - name: Skip check for Renovate bot
        if: ${{ github.actor == 'renovate[bot]' }}
        run: |
          echo "✅ Skipping issue link check for Renovate bot PR."
          exit 0

      - name: Validate PR description for GitHub issue links
        run: |
          set -euo pipefail

          # Ensure jq is available (runner ubuntu-latest usually has jq)
          if ! command -v jq >/dev/null 2>&1; then
            echo "jq not found, attempting to install..."
            sudo apt-get update -y
            sudo apt-get install -y jq
          fi

          # Safely read PR body from the event JSON (avoids direct interpolation of the body into the script)
          PR_BODY=$(jq -r '.pull_request.body // ""' "$GITHUB_EVENT_PATH")

          # Extract all issue numbers from PR description
          ISSUE_NUMBERS=$(echo "$PR_BODY" | grep -oE '#[0-9]+' | tr -d '#')

          if [ -z "$ISSUE_NUMBERS" ]; then
            echo "❌ No GitHub issue link found in PR description."
            echo "Please include a reference like 'Fixes #123', 'Closes #123', or 'Resolves #123'."
            exit 1
          fi

          echo "Found issue numbers: $ISSUE_NUMBERS"

          # Check each issue status via GitHub API
          for ISSUE in $ISSUE_NUMBERS; do
            echo "Checking issue #$ISSUE..."
            RESPONSE=$(curl -s -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
              -H "Accept: application/vnd.github.v3+json" \
              https://api.github.com/repos/${{ github.repository }}/issues/$ISSUE)

            STATE=$(echo "$RESPONSE" | jq -r '.state')

            if [ "$STATE" != "open" ]; then
              echo "❌ Issue #$ISSUE is not open (state: $STATE)."
              exit 1
            fi

            echo "✅ Issue #$ISSUE is open."
          done
